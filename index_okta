const express = require('express');
const passport = require('passport');
const SamlStrategy = require('passport-saml').Strategy;
const session = require('express-session');
const fs = require('fs');
const bodyParser = require('body-parser');
const SQLiteStore = require('connect-sqlite3')(session); // âœ… Session persistence

const app = express();
const PORT = process.env.PORT || 3000;
app.use((req, res, next) => {
  res.setHeader('ngrok-skip-browser-warning', 'any-value');
  next();
});

// âœ… Configure Express Session with Persistent Store
app.use(session({
  secret: "supersecret",
  resave: false,
  saveUninitialized: false, // âœ… Prevents empty sessions
  store: new SQLiteStore(), // âœ… Stores sessions persistently
  cookie: {
    secure: false,  // Set to `true` if using HTTPS
    httpOnly: true,
    sameSite: "lax"
  }
}));

// âœ… Middleware to Parse SAML Responses
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

// âœ… Configure Passport for SAML Authentication
passport.use(new SamlStrategy(
  {
    path: '/saml/acs',
    entryPoint: 'https://trial-8778691.okta.com/app/trial-8778691_nodeapp_1/exkpx67lrbXzRchaI697/sso/saml',
    issuer: 'https://35ea-93-174-85-223.ngrok-free.app',
    cert: fs.readFileSync('okta.cert', 'utf8'),
    callbackUrl: 'https://35ea-93-174-85-223.ngrok-free.app/saml/acs',
  },
  (profile, done) => {
    console.log("âœ… SAML Profile Received:", profile);
    return done(null, profile);
  }
));

// âœ… Serialize and Deserialize User
passport.serializeUser((user, done) => {
  console.log("ðŸ” Serializing User:", user);
  done(null, user);
});

passport.deserializeUser((user, done) => {
  console.log("ðŸ”“ Deserializing User:", user);
  done(null, user);
});

// âœ… Initialize Passport
app.use(passport.initialize());
app.use(passport.session());

// âœ… Middleware to Check if User is Authenticated
const isAuthenticated = (req, res, next) => {
  console.log("ðŸ” Checking authentication:", req.isAuthenticated());
  console.log("ðŸ” Session Data:", req.session);

  if (req.isAuthenticated()) {
    return next();
  }

  console.log("âŒ User is not authenticated. Redirecting to login.");
  res.redirect('/login');
};

// âœ… Protected Route: Requires Authentication
app.get('/', isAuthenticated, (req, res) => {
  res.json({ message: "Hello, Yonder!" });
});

// âœ… Login Route (Redirects to Okta for SAML Authentication)
app.get('/login', passport.authenticate('saml'));

// âœ… Callback Route (Handles SAML Response from Okta)
app.post('/saml/acs', 
  (req, res, next) => {
    console.log("ðŸ“© SAML Response Received:", req.body);
    next();
  },
  passport.authenticate('saml', { failureRedirect: '/', failureFlash: true }),
  (req, res) => {
    console.log("âœ… User Authenticated:", req.user);
    
    // ðŸ”¹ Store User in Session Manually (FIX)
    req.session.user = req.user;
    req.session.save(err => {
      if (err) {
        console.error("âš ï¸ Session Save Error:", err);
      }
      res.redirect('/'); // ðŸ”¹ Redirect user to home page after login
    });
  }
);

// âœ… Logout Route (Clears Session & Redirects)
app.get('/logout', (req, res) => {
  req.logout(() => res.redirect('/'));
});

app.listen(PORT, () => {
  console.log(`âœ… Server is running on port ${PORT}`);
});
